1 . QUERY TANPA GROUP BY 

SELECT 
    puskesmas_id,
    kecamatan,
    nama,
    SUM(jumlah_kk) AS total_jumlah_kk,
    SUM(total_asa) AS total_asa,
    SUM(total_sls) AS total_sls,
    SUM(total_slb) AS total_slb,
    SUM(total_bl) AS total_bl,
    SUM(total_btp) AS total_btp,
    SUM(total_btk) AS total_btk,
    SUM(total_sbs) AS total_sbs,
	SUM(total_sl) AS total_sl,
 	CASE WHEN SUM(jumlah_kk) != 0 THEN (SUM(total_sbs)::FLOAT / SUM(jumlah_kk) * 100) ELSE NULL END AS persentase_sbs,
    CASE WHEN SUM(jumlah_kk) != 0 THEN (SUM(total_sl)::FLOAT / SUM(jumlah_kk) * 100) ELSE NULL END AS persentase_sl,
    CASE WHEN SUM(jumlah_kk) != 0 THEN (SUM(total_asa)::FLOAT / SUM(jumlah_kk) * 100) ELSE NULL END AS persentase_asa
FROM (
    SELECT 
        ti.puskesmas_id,
        mp.kecamatan,
        mp.nama,
        ti.jumlah_kk,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'SANITASI AMAN' AND tip.bobot > 0) AS total_asa,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'SANITASI LAYAK SENDIRI' AND tip.bobot > 0) AS total_sls,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'SANITASI LAYAK BERSAMA' AND tip.bobot > 0) AS total_slb,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'BELUM LAYAK' AND tip.bobot > 0) AS total_bl,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'BABS TERTUTUP' AND tip.bobot > 0) AS total_btp,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'BABS TERBUKA' AND tip.bobot > 0) AS total_btk,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id IN ('SANITASI AMAN', 'SANITASI LAYAK SENDIRI', 'SANITASI LAYAK BERSAMA', 'BELUM LAYAK') AND tip.bobot > 0) AS total_sbs,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id IN ('SANITASI AMAN', 'SANITASI LAYAK SENDIRI', 'SANITASI LAYAK BERSAMA') AND tip.bobot > 0) AS total_sl
    FROM 
        t_inspeksi ti
    JOIN 
        m_puskesmas mp ON mp.id = ti.puskesmas_id
    WHERE 
        ti.jenis = 'SANITASI LAYAK AMAN'
) AS subquery_alias
GROUP BY puskesmas_id, kecamatan, nama;





2. QUERY DENGAN GROUP BY 

SELECT 
    puskesmas_id,
    kecamatan,
    puskesmas,
    SUM(jumlah_kk) AS total_jumlah_kk,
    SUM(total_asa) AS total_asa,
    SUM(total_sls) AS total_sls,
    SUM(total_slb) AS total_slb,
    SUM(total_bl) AS total_bl,
    SUM(total_btp) AS total_btp,
    SUM(total_btk) AS total_btk,
    SUM(total_sbs) AS total_sbs,
	SUM(total_sl) AS total_sl,
 	CASE WHEN SUM(jumlah_kk) != 0 THEN (SUM(total_sbs)::FLOAT / SUM(jumlah_kk) * 100) ELSE NULL END AS persentase_sbs,
    CASE WHEN SUM(jumlah_kk) != 0 THEN (SUM(total_sl)::FLOAT / SUM(jumlah_kk) * 100) ELSE NULL END AS persentase_sl,
    CASE WHEN SUM(jumlah_kk) != 0 THEN (SUM(total_asa)::FLOAT / SUM(jumlah_kk) * 100) ELSE NULL END AS persentase_asa
FROM (
    SELECT 
        ti.puskesmas_id,
        mp.kecamatan,
        mp.nama puskesmas,
        ti.jumlah_kk,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'SANITASI AMAN' AND tip.bobot > 0) AS total_asa,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'SANITASI LAYAK SENDIRI' AND tip.bobot > 0) AS total_sls,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'SANITASI LAYAK BERSAMA' AND tip.bobot > 0) AS total_slb,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'BELUM LAYAK' AND tip.bobot > 0) AS total_bl,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'BABS TERTUTUP' AND tip.bobot > 0) AS total_btp,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'BABS TERBUKA' AND tip.bobot > 0) AS total_btk,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id IN ('SANITASI AMAN', 'SANITASI LAYAK SENDIRI', 'SANITASI LAYAK BERSAMA', 'BELUM LAYAK') AND tip.bobot > 0) AS total_sbs,
        (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id IN ('SANITASI AMAN', 'SANITASI LAYAK SENDIRI', 'SANITASI LAYAK BERSAMA') AND tip.bobot > 0) AS total_sl
    FROM 
        t_inspeksi ti
    JOIN 
        m_puskesmas mp ON mp.id = ti.puskesmas_id
    WHERE 
        ti.jenis = 'SANITASI LAYAK AMAN'
) AS subquery_alias
GROUP BY puskesmas_id, kecamatan, puskesmas;

SELECT BY PUSKESMAS

$raw = \DB::select("
              SELECT 
                  kecamatan,
                  puskesmas,
                  SUM(jumlah_kk) AS total_jumlah_kk,
                  SUM(total_asa) AS total_asa,
                  SUM(total_sls) AS total_sls,
                  SUM(total_slb) AS total_slb,
                  SUM(total_bl) AS total_bl,
                  SUM(total_btp) AS total_btp,
                  SUM(total_btk) AS total_btk,
                  SUM(total_sbs) AS total_sbs,
                SUM(total_sl) AS total_sl,
                CASE WHEN SUM(jumlah_kk) != 0 THEN (SUM(total_sbs)::FLOAT / SUM(jumlah_kk) * 100) ELSE 0 END AS persentase_sbs,
                  CASE WHEN SUM(jumlah_kk) != 0 THEN (SUM(total_sl)::FLOAT / SUM(jumlah_kk) * 100) ELSE 0 END AS persentase_sl,
                  CASE WHEN SUM(jumlah_kk) != 0 THEN (SUM(total_asa)::FLOAT / SUM(jumlah_kk) * 100) ELSE 0 END AS persentase_asa
              FROM (
                  SELECT 
                      mp.kecamatan,
                      mp.nama puskesmas,
                      (SELECT COUNT(mk.id) FROM m_kepalakeluarga mk WHERE mk.puskesmas_id = mp.id) AS jumlah_kk,
                      (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'SANITASI AMAN' AND tip.bobot > 0  AND ti.jenis = 'SANITASI LAYAK AMAN' AND ti.puskesmas_id = mp.id) AS total_asa,
                      (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'SANITASI LAYAK SENDIRI' AND tip.bobot > 0  AND ti.jenis = 'SANITASI LAYAK AMAN' AND ti.puskesmas_id = mp.id) AS total_sls,
                      (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'SANITASI LAYAK BERSAMA' AND tip.bobot > 0  AND ti.jenis = 'SANITASI LAYAK AMAN' AND ti.puskesmas_id = mp.id) AS total_slb,
                      (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'BELUM LAYAK' AND tip.bobot > 0  AND ti.jenis = 'SANITASI LAYAK AMAN' AND ti.puskesmas_id = mp.id) AS total_bl,
                      (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'BABS TERTUTUP' AND tip.bobot > 0  AND ti.jenis = 'SANITASI LAYAK AMAN' AND ti.puskesmas_id = mp.id) AS total_btp,
                      (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id = 'BABS TERBUKA' AND tip.bobot > 0  AND ti.jenis = 'SANITASI LAYAK AMAN' AND ti.puskesmas_id = mp.id) AS total_btk,
                      (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id IN ('SANITASI AMAN', 'SANITASI LAYAK SENDIRI', 'SANITASI LAYAK BERSAMA', 'BELUM LAYAK' ) AND tip.bobot > 0 AND ti.jenis = 'SANITASI LAYAK AMAN' AND ti.puskesmas_id = mp.id) AS total_sbs,
                      (SELECT COUNT(tip.kategori_id) FROM t_inspeksi_det_param tip WHERE tip.t_inspeksi_id = ti.id AND tip.kategori_id IN ('SANITASI AMAN', 'SANITASI LAYAK SENDIRI', 'SANITASI LAYAK BERSAMA') AND tip.bobot > 0  AND ti.jenis = 'SANITASI LAYAK AMAN' AND ti.puskesmas_id = mp.id) AS total_sl
                  FROM 
                      m_puskesmas mp
                  LEFT JOIN 
                      t_inspeksi ti ON mp.id = ti.puskesmas_id AND ti.tanggal BETWEEN ? AND ?
                    WHERE 
                      mp.kecamatan = coalesce(?, mp.kecamatan) AND 
                      mp.id = coalesce(?, mp.id)
                  ) AS subquery_alias
                GROUP BY kecamatan, puskesmas
                ORDER BY puskesmas 
  ", [ $periode_from, $periode_to, $req->kecamatan, $req->puskesmas_id]);

    QUERY BARU

   $raw = \DB::select("
                SELECT 
                    kecamatan,
                    puskesmas,
                    SUM(jumlah_kk) AS total_jumlah_kk,
                    SUM(total_asa) AS total_asa,
                    SUM(total_sls) AS total_sls,
                    SUM(total_slb) AS total_slb,
                    SUM(total_bl) AS total_bl,
                    SUM(total_btp) AS total_btp,
                    SUM(total_btk) AS total_btk,
                    SUM(total_sbs) AS total_sbs,
                    SUM(total_sl) AS total_sl,
                    CASE WHEN SUM(jumlah_kk) != 0 THEN (SUM(total_sbs)::FLOAT / SUM(jumlah_kk) * 100) ELSE 0 END AS persentase_sbs,
                    CASE WHEN SUM(jumlah_kk) != 0 THEN (SUM(total_sl)::FLOAT / SUM(jumlah_kk) * 100) ELSE 0 END AS persentase_sl,
                    CASE WHEN SUM(jumlah_kk) != 0 THEN (SUM(total_asa)::FLOAT / SUM(jumlah_kk) * 100) ELSE 0 END AS persentase_asa
                FROM (
                    SELECT 
                        mp.kecamatan,
                        mp.nama AS puskesmas,
                        COALESCE(mk.jumlah_kk, 0) AS jumlah_kk,
                        COALESCE(tip.total_asa, 0) AS total_asa,
                        COALESCE(tip.total_sls, 0) AS total_sls,
                        COALESCE(tip.total_slb, 0) AS total_slb,
                        COALESCE(tip.total_bl, 0) AS total_bl,
                        COALESCE(tip.total_btp, 0) AS total_btp,
                        COALESCE(tip.total_btk, 0) AS total_btk,
                        COALESCE(tip.total_sbs, 0) AS total_sbs,
                        COALESCE(tip.total_sl, 0) AS total_sl
                    FROM 
                        m_puskesmas mp
                    LEFT JOIN (
                        SELECT 
                            puskesmas_id,
                            COUNT(id) AS jumlah_kk
                        FROM 
                            m_kepalakeluarga
                        GROUP BY 
                            puskesmas_id
                    ) mk ON mp.id = mk.puskesmas_id
                    LEFT JOIN (
                        SELECT 
                            ti.puskesmas_id,
                            COUNT(tip.kategori_id) FILTER(WHERE tip.kategori_id = 'SANITASI AMAN' AND tip.bobot > 0 AND ti.jenis = 'SANITASI LAYAK AMAN') AS total_asa,
                            COUNT(tip.kategori_id) FILTER(WHERE tip.kategori_id = 'SANITASI LAYAK SENDIRI' AND tip.bobot > 0 AND ti.jenis = 'SANITASI LAYAK AMAN') AS total_sls,
                            COUNT(tip.kategori_id) FILTER(WHERE tip.kategori_id = 'SANITASI LAYAK BERSAMA' AND tip.bobot > 0 AND ti.jenis = 'SANITASI LAYAK AMAN') AS total_slb,
                            COUNT(tip.kategori_id) FILTER(WHERE tip.kategori_id = 'BELUM LAYAK' AND tip.bobot > 0 AND ti.jenis = 'SANITASI LAYAK AMAN') AS total_bl,
                            COUNT(tip.kategori_id) FILTER(WHERE tip.kategori_id = 'BABS TERTUTUP' AND tip.bobot > 0 AND ti.jenis = 'SANITASI LAYAK AMAN') AS total_btp,
                            COUNT(tip.kategori_id) FILTER(WHERE tip.kategori_id = 'BABS TERBUKA' AND tip.bobot > 0 AND ti.jenis = 'SANITASI LAYAK AMAN') AS total_btk,
                            COUNT(tip.kategori_id) FILTER(WHERE tip.kategori_id IN ('SANITASI AMAN', 'SANITASI LAYAK SENDIRI', 'SANITASI LAYAK BERSAMA', 'BELUM LAYAK') AND tip.bobot > 0 AND ti.jenis = 'SANITASI LAYAK AMAN') AS total_sbs,
                            COUNT(tip.kategori_id) FILTER(WHERE tip.kategori_id IN ('SANITASI AMAN', 'SANITASI LAYAK SENDIRI', 'SANITASI LAYAK BERSAMA') AND tip.bobot > 0 AND ti.jenis = 'SANITASI LAYAK AMAN') AS total_sl
                        FROM 
                            t_inspeksi ti
                        LEFT JOIN 
                            t_inspeksi_det_param tip ON ti.id = tip.t_inspeksi_id
                        WHERE 
                            ti.tanggal BETWEEN ? AND ?
                        GROUP BY 
                            ti.puskesmas_id
                    ) tip ON mp.id = tip.puskesmas_id
                    WHERE 
                        mp.kecamatan = COALESCE(?, mp.kecamatan) AND 
                        mp.id = COALESCE(?, mp.id)
                ) AS subquery_alias
                GROUP BY kecamatan, puskesmas
                ORDER BY puskesmas 
            ", [$periode_from, $periode_to, $req->kecamatan, $req->puskesmas_id]);



 REPORT TFU


                          SELECT 
                kecamatan,
                puskesmas,
                SUM(total_smp) AS total_smp,
                SUM(total_sd) AS total_sd,
                SUM(total_puskesmas) AS total_puskesmas,
                SUM(total_pasar) AS total_pasar,
                SUM(total_smp_tfu) AS total_smp_tfu,
                SUM(total_sd_tfu) AS total_sd_tfu,
                SUM(total_puskesmas_tfu) AS total_puskesmas_tfu,
                SUM(total_pasar_tfu) AS total_pasar_tfu,
                (SUM(total_pasar)+SUM(total_puskesmas)+SUM(total_sd)+SUM(total_smp)) AS total,
                CASE WHEN SUM(total_smp) != 0 THEN (SUM(total_smp_tfu)::FLOAT / SUM(total_smp) * 100) ELSE 0 END AS persentase_smp_tfu,
                CASE WHEN SUM(total_sd) != 0 THEN (SUM(total_sd_tfu)::FLOAT / SUM(total_sd) * 100) ELSE 0 END AS persentase_sd_tfu,
                CASE WHEN SUM(total_puskesmas) != 0 THEN (SUM(total_puskesmas_tfu)::FLOAT / SUM(total_puskesmas) * 100) ELSE 0 END AS persentase_puskesmas_tfu,
                CASE WHEN SUM(total_pasar) != 0 THEN (SUM(total_pasar_tfu)::FLOAT / SUM(total_pasar) * 100) ELSE 0 END AS persentase_pasar_tfu
                FROM (
                  SELECT 
                    mp.kecamatan,
                    mp.nama puskesmas,
                    COALESCE(mtp.total_smp, 0) AS total_smp,
                    COALESCE(mtp.total_sd, 0) AS total_sd,
                    COALESCE(mtp.total_puskesmas, 0) AS total_puskesmas,
                    COALESCE(mtp.total_pasar, 0) AS total_pasar,
                    COALESCE(tip.total_smp_tfu, 0) AS total_smp_tfu,
                    COALESCE(tip.total_sd_tfu, 0) AS total_sd_tfu,
                    COALESCE(tip.total_puskesmas_tfu, 0) AS total_puskesmas_tfu,
                    COALESCE(tip.total_pasar_tfu, 0) AS total_pasar_tfu
                  FROM 
                      m_puskesmas mp
                  LEFT JOIN 
                    (SELECT 
                        mt.puskesmas_id,
                        COUNT(id) FILTER(WHERE mt.jenis_tfu_id = 2 AND mt.sub_jenis_tfu_id = 6) AS total_smp, 
                        COUNT(id) FILTER(WHERE mt.jenis_tfu_id = 2 AND mt.sub_jenis_tfu_id = 5) AS total_sd,
                        COUNT(id) FILTER(WHERE mt.jenis_tfu_id = 3) AS total_puskesmas, 
                        COUNT(id) FILTER(WHERE mt.jenis_tfu_id = 4) AS total_pasar 
                        FROM 
                          m_tfu mt 
                        GROUP BY 
                          mt.puskesmas_id
                    ) mtp 
                      ON mp.id = mtp.puskesmas_id
                    LEFT JOIN
                      (SELECT
                        ti.puskesmas_id,
                        COUNT(ti.id) FILTER(WHERE mt1.jenis_tfu_id = 2 AND mt1.sub_jenis_tfu_id = 5 AND ti.jenis = 'PEMBINAAN TFU') AS total_smp_tfu,
                        COUNT(ti.id) FILTER(WHERE mt1.jenis_tfu_id = 2 AND mt1.sub_jenis_tfu_id = 6 AND ti.jenis = 'PEMBINAAN TFU') AS total_sd_tfu,
                        COUNT(ti.id) FILTER(WHERE mt1.jenis_tfu_id = 3 AND ti.jenis = 'PEMBINAAN TFU') AS total_puskesmas_tfu,
                        COUNT(ti.id) FILTER(WHERE mt1.jenis_tfu_id = 4 AND ti.jenis = 'PEMBINAAN TFU') AS total_pasar_tfu
                        
                      FROM 
                        t_inspeksi ti
                      JOIN
                        m_tfu mt1 ON mt1.id = ti.ref_id
                      WHERE 
                        ti.tanggal BETWEEN ? AND ?
                      GROUP BY 
                        ti.puskesmas_id
                      ) tip ON mp.id = tip.puskesmas_id
                    WHERE 
                      mp.kecamatan = COALESCE(?, mp.kecamatan) AND 
                      mp.id = COALESCE(?, mp.id)
                ) AS subquery_alias
                GROUP BY kecamatan, puskesmas
                ORDER BY puskesmas 


QUERY 5 Pilar

		SELECT 
			no_kk,
			nama,
			SUM(jumlah_kk_menetap) AS jumlah_kk_menetap,
			SUM(jumlah_sarana) AS jumlah_sarana,
			CASE WHEN SUM(total_p11) > 0 THEN 'Y' WHEN SUM(total_p11) = 0 THEN 'T' ELSE NULL END AS total_p11,
			CASE WHEN SUM(total_p12) > 0 THEN 'Y' WHEN SUM(total_p12) = 0 THEN 'T' ELSE NULL END AS total_p12,
			CASE WHEN SUM(total_p14) > 0 THEN 'Y' WHEN SUM(total_p14) = 0 THEN 'T' ELSE NULL END AS total_p14,
			CASE WHEN SUM(total_p15) > 0 THEN 'Y' WHEN SUM(total_p15) = 0 THEN 'T' ELSE NULL END AS total_p15,
			CASE WHEN SUM(total_p16) > 0 THEN 'Y' WHEN SUM(total_p16) = 0 THEN 'T' ELSE NULL END AS total_p16,
			CASE WHEN SUM(total_p17) > 0 THEN 'Y' WHEN SUM(total_p17) = 0 THEN 'T' ELSE NULL END AS total_p17,
			CASE WHEN SUM(total_p18) > 0 THEN 'Y' WHEN SUM(total_p18) = 0 THEN 'T' ELSE NULL END AS total_p18,
			CASE WHEN SUM(total_p21) > 0 THEN 'Y' WHEN SUM(total_p21) = 0 THEN 'T' ELSE NULL END AS total_p21,
			CASE WHEN SUM(total_p22) > 0 THEN 'Y' WHEN SUM(total_p22) = 0 THEN 'T' ELSE NULL END AS total_p22,
			CASE WHEN SUM(total_p24) > 0 THEN 'Y' WHEN SUM(total_p24) = 0 THEN 'T' ELSE NULL END AS total_p24,
			CASE WHEN SUM(total_p25) > 0 THEN 'Y' WHEN SUM(total_p25) = 0 THEN 'T' ELSE NULL END AS total_p25,
			CASE WHEN SUM(total_p26) > 0 THEN 'Y' WHEN SUM(total_p26) = 0 THEN 'T' ELSE NULL END AS total_p26,
			CASE WHEN SUM(total_p27) > 0 THEN 'Y' WHEN SUM(total_p27) = 0 THEN 'T' ELSE NULL END AS total_p27,
			CASE WHEN SUM(total_p32) > 0 THEN 'Y' WHEN SUM(total_p32) = 0 THEN 'T' ELSE NULL END AS total_p32,
			CASE WHEN SUM(total_p33) > 0 THEN 'Y' WHEN SUM(total_p33) = 0 THEN 'T' ELSE NULL END AS total_p33,
			CASE WHEN SUM(total_p34) > 0 THEN 'Y' WHEN SUM(total_p34) = 0 THEN 'T' ELSE NULL END AS total_p34,
			CASE WHEN SUM(total_p36) > 0 THEN 'Y' WHEN SUM(total_p36) = 0 THEN 'T' ELSE NULL END AS total_p36,
			CASE WHEN SUM(total_p37) > 0 THEN 'Y' WHEN SUM(total_p37) = 0 THEN 'T' ELSE NULL END AS total_p37,
			CASE WHEN SUM(total_p38) > 0 THEN 'Y' WHEN SUM(total_p38) = 0 THEN 'T' ELSE NULL END AS total_p38,
			CASE WHEN SUM(total_p41) > 0 THEN 'Y' WHEN SUM(total_p41) = 0 THEN 'T' ELSE NULL END AS total_p41,
			CASE WHEN SUM(total_p42) > 0 THEN 'Y' WHEN SUM(total_p42) = 0 THEN 'T' ELSE NULL END AS total_p42,
			CASE WHEN SUM(total_p43) > 0 THEN 'Y' WHEN SUM(total_p43) = 0 THEN 'T' ELSE NULL END AS total_p43,
			CASE WHEN SUM(total_p44) > 0 THEN 'Y' WHEN SUM(total_p44) = 0 THEN 'T' ELSE NULL END AS total_p44,
			CASE WHEN SUM(total_p51) > 0 THEN 'Y' WHEN SUM(total_p51) = 0 THEN 'T' ELSE NULL END AS total_p51,
			CASE WHEN SUM(total_p52) > 0 THEN 'Y' WHEN SUM(total_p52) = 0 THEN 'T' ELSE NULL END AS total_p52,
			CASE WHEN SUM(total_p53) > 0 THEN 'Y' WHEN SUM(total_p53) = 0 THEN 'T' ELSE NULL END AS total_p53
		FROM (
			SELECT
				kk.no_kk,
				kk.nama,
				COALESCE(ti.jumlah_kk_menetap, 0) AS jumlah_kk_menetap,
				COALESCE(ti.jumlah_sarana, 0) AS jumlah_sarana,
				COALESCE(ti2.total_p11, null) AS total_p11,
				COALESCE(ti2.total_p12, null) AS total_p12,
				COALESCE(ti2.total_p14, null) AS total_p14,
				COALESCE(ti2.total_p15, null) AS total_p15,
				COALESCE(ti2.total_p16, null) AS total_p16,
				COALESCE(ti2.total_p17, null) AS total_p17,
				COALESCE(ti2.total_p18, null) AS total_p18,
				COALESCE(ti2.total_p21, null) AS total_p21,
				COALESCE(ti2.total_p22, null) AS total_p22,
				COALESCE(ti2.total_p24, null) AS total_p24,
				COALESCE(ti2.total_p25, null) AS total_p25,
				COALESCE(ti2.total_p26, null) AS total_p26,
				COALESCE(ti2.total_p27, null) AS total_p27,
				COALESCE(ti2.total_p32, null) AS total_p32,
				COALESCE(ti2.total_p33, null) AS total_p33,
				COALESCE(ti2.total_p34, null) AS total_p34,
				COALESCE(ti2.total_p36, null) AS total_p36,
				COALESCE(ti2.total_p37, null) AS total_p37,
				COALESCE(ti2.total_p38, null) AS total_p38,
				COALESCE(ti2.total_p41, null) AS total_p41,
				COALESCE(ti2.total_p42, null) AS total_p42,
				COALESCE(ti2.total_p43, null) AS total_p43,
				COALESCE(ti2.total_p44, null) AS total_p44,
				COALESCE(ti2.total_p51, null) AS total_p51,
				COALESCE(ti2.total_p52, null) AS total_p52,
				COALESCE(ti2.total_p53, null) AS total_p53		
			FROM 
				m_kepalakeluarga kk
			LEFT JOIN (
				SELECT 
					ref_id, jumlah_kk_menetap, jumlah_sarana
				FROM 
					t_inspeksi 
				GROUP BY 
					ref_id, jumlah_kk_menetap, jumlah_sarana
			) ti ON kk.id = ti.ref_id
			LEFT JOIN (
				SELECT 
					ti1.ref_id,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 405 AND tip.no_urut = 1 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p11,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 406 AND tip.no_urut = 2 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p12,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 408 AND tip.no_urut = 4 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p14,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 409 AND tip.no_urut = 5 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p15,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 410 AND tip.no_urut = 6 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p16,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 411 AND tip.no_urut = 7 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p17,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 412 AND tip.no_urut = 8 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p18,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 413 AND tip.no_urut = 1 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p21,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 414 AND tip.no_urut = 2 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p22,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 416 AND tip.no_urut = 4 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p24,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 417 AND tip.no_urut = 5 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p25,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 418 AND tip.no_urut = 6 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p26,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 419 AND tip.no_urut = 7 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p27,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 421 AND tip.no_urut = 2 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p32,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 422 AND tip.no_urut = 3 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p33,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 423 AND tip.no_urut = 4 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p34,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 425 AND tip.no_urut = 6 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p36,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 426 AND tip.no_urut = 7 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p37,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 427 AND tip.no_urut = 8 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p38,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 428 AND tip.no_urut = 1 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p41,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 429 AND tip.no_urut = 2 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p42,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 430 AND tip.no_urut = 3 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p43,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 431 AND tip.no_urut = 4 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p44,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 432 AND tip.no_urut = 1 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p51,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 433 AND tip.no_urut = 2 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p52,
					COUNT(tip.id) FILTER(WHERE tip.m_pertanyaan_det_param_id = 434 AND tip.no_urut = 3 AND ti1.jenis = 'MONITORING 5 PILAR STBM DESA' AND tip.hasil > 0) AS total_p53

				FROM 
					t_inspeksi ti1
				LEFT JOIN 
					t_inspeksi_det_param tip ON ti1.id = tip.t_inspeksi_id
				WHERE 
					ti.tanggal BETWEEN ? AND ?
				GROUP BY 
					ti1.ref_id
			) ti2 ON kk.id = ti2.ref_id
			WHERE 
				kk.kecamatan = COALESCE(?, kk.kecamatan) AND 
				kk.puskesmas_id = COALESCE(?, kk.puskesmas_id)
		) AS subquery_alias
		GROUP BY no_kk, nama;


